CODE REGISTRO PRESUPUESTO
A função desse code é transformar essa string que vem com todas as informações aglutinadas  em um JSON organizado, com cada campo separado corretamente. O output já sai no formato adequado para o schema do n8n e para o input do Agente Registro.
Depois que isso foi implementado, o workflow passou a registrar os dados na tabela de forma consistente, resolvendo os erros que aconteciam quando tentávamos salvar os valores diretamente a partir da string original.

// ====== 1. Recupera o texto de forma segura ======
const input = $input.first().json;
const possibleFields = ["text", "mensagem", "message", "contenido", "raw", "prompt", "output"];
let text = "";

for (const field of possibleFields) {
  if (input[field]) {
    text = input[field];
    break;
  }
}

if (!text) {
  for (const key in input) {
    if (typeof input[key] === "string") {
      text = input[key];
      break;
    }
  }
}

if (!text) {
  throw new Error("❌ Nenhum campo de texto encontrado no input. Verifique qual campo contém a mensagem do agente.");
}

// ====== 2. Função segura de extração com regex ======
function extract(pattern, str) {
  if (!str || typeof str !== "string") return "";
  const match = str.match(pattern);
  return match ? match[1].trim() : "";
}

// ====== 3. Extrai nome do cliente ======
const cliente = extract(/Cliente:\s*(.+)/i, text);

// ====== 4. Extrai envío global (o último que aparece no texto) ======
const envioMatches = text.match(/Envío e instalación:\s*\$?\s*([\d.,]+)/gi);
let envioGlobal = "";
if (envioMatches && envioMatches.length > 0) {
  // Pega o ÚLTIMO match
  const ultimoEnvio = envioMatches[envioMatches.length - 1];
  envioGlobal = extract(/Envío e instalación:\s*\$?\s*([\d.,]+)/i, ultimoEnvio);
}

// ====== 5. Detecta múltiplos muebles ======
let bloques;
if (/Mueble\s*\d+:/i.test(text)) {
  // Divide por "Mueble X:"
  bloques = text.split(/Mueble\s*\d+:/i).slice(1);
} else {
  // Só um mueble - pega tudo após "Cliente:"
  bloques = [text];
}

const items = [];

bloques.forEach((bloque, index) => {
  // Extrai cada campo individualmente
  const mueble = extract(/Mueble:\s*(.+)/i, bloque);
  const ancho = extract(/Ancho:\s*([\d.,]+)/i, bloque);
  const alto = extract(/Alto:\s*([\d.,]+)/i, bloque);
  const profundidad = extract(/Profundidad:\s*([\d.,]+)/i, bloque);
  const material = extract(/Material:\s*(.+)/i, bloque);
  const adicionales = extract(/Adicionales:\s*(.+)/i, bloque);
  const precioMueble = extract(/Precio Mueble:\s*\$?\s*([\d.,]+)/i, bloque);
  const precioExtra = extract(/Precio Extra:\s*\$?\s*([\d.,]+)/i, bloque);
  
  // Usa o envío global extraído anteriormente
  const envio = envioGlobal || "";

  items.push({
    json: {
      CLIENTE: cliente || "",
      ITEM: index + 1,
      TIPO_MUEBLE: mueble || "",
      ANCHO: ancho || "",
      ALTO: alto || "",
      PROFUNDIDAD: profundidad || "",
      MATERIAL: material || "",
      ADICIONALES: adicionales || "",
      PRECIO_MUEBLE: precioMueble || "",
      PRECIO_EXTRA: precioExtra || "",
      ENVIO_INSTALACION: envio
    }
  });
});

return items;
-----------------------

// CODE 01 CONFIRMAR PRESUPUESTO
// Os dados do orçamento são extraídos na tabela “momentaneo” e leva para um node code que separa cada detalhe do orçamento em diferentes itens.

const items = [];

// Agrupa os itens por cliente
const clienteData = {
  cliente: "",
  envioInstalacion: 0,
  precioTotal: 0,
  // Inicializa todos os 4 itens possíveis como vazios
  item1_tipo: "",
  item1_ancho: "",
  item1_profundidad: "",
  item1_altura: "",
  item1_material: "",
  item1_adicionales: "",
  item1_precio: "",
  item1_material_extra: "",
  item1_extra_precio: "",
  
  item2_tipo: "",
  item2_ancho: "",
  item2_profundidad: "",
  item2_altura: "",
  item2_material: "",
  item2_adicionales: "",
  item2_precio: "",
  item2_material_extra: "",
  item2_extra_precio: "",
  
  item3_tipo: "",
  item3_ancho: "",
  item3_profundidad: "",
  item3_altura: "",
  item3_material: "",
  item3_adicionales: "",
  item3_precio: "",
  item3_material_extra: "",
  item3_extra_precio: "",
  
  item4_tipo: "",
  item4_ancho: "",
  item4_profundidad: "",
  item4_altura: "",
  item4_material: "",
  item4_adicionales: "",
  item4_precio: "",
  item4_material_extra: "",
  item4_extra_precio: ""
};

const inputItems = $input.all();

if (inputItems.length > 0) {
  // Pega o nome do cliente do primeiro item
  clienteData.cliente = inputItems[0].json["NOMBRE CLIENTE"] || "";
  
  // Preenche apenas os itens que existem
  inputItems.forEach((item, index) => {
    const itemNum = index + 1;
    
    if (itemNum <= 4) {
      clienteData[`item${itemNum}_tipo`] = item.json["TIPO MUEBLE"] || "";
      clienteData[`item${itemNum}_ancho`] = item.json["ANCHO"] || "";
      clienteData[`item${itemNum}_profundidad`] = item.json["PRODUNIDAD"] || "";
      clienteData[`item${itemNum}_altura`] = item.json["ALTURA"] || "";
      clienteData[`item${itemNum}_material`] = item.json["MATERIAL"] || "";
      clienteData[`item${itemNum}_adicionales`] = item.json["ADICIONALES"] || "";
      clienteData[`item${itemNum}_precio`] = item.json["PRECIO"] ? `$${item.json["PRECIO"].toLocaleString('es-AR')}` : "";
       clienteData[`item${itemNum}_material_extra`] = item.json["MATERIAL EXTRA"] || "";

      clienteData[`item${itemNum}_extra_precio`] = item.json["PRECIO ADICIONAL"] ? `$${item.json["PRECIO ADICIONAL"].toLocaleString('es-AR')}` : "";
      
      // Soma o envio apenas uma vez (do primeiro item)
      if (index === 0) {
        clienteData.envioInstalacion = item.json["Envio e Instalacion"] || 0;
      }
      
      // Soma os preços
   clienteData.precioTotal += (item.json["PRECIO"] || 0) + (item.json["PRECIO ADICIONAL"] || 0);
    }
  });
  
  // Adiciona envio ao total
  clienteData.precioTotal += clienteData.envioInstalacion;
  
  // Formata valores monetários
  clienteData.envioInstalacion = `$${clienteData.envioInstalacion.toLocaleString('es-AR')}`;
  clienteData.precioTotal = `$${clienteData.precioTotal.toLocaleString('es-AR')}`;
}

items.push({ json: clienteData });

return items;

----------------------

// CODE 02 CONFIRMAR PRESUPUESTO
// O segundo node code volta a printar os dados da tabela e salva as informações no “Histórico”. Também cria um id para cada orçamento.

const items = [];
const inputItems = $input.all();

// Gera um ID único para este orçamento
const orcamentoId = `ORC-${Date.now()}`;
const fecha = new Date().toLocaleDateString('es-AR');

// Para cada item do orçamento, cria uma linha para o histórico
inputItems.forEach((item) => {
  items.push({ 
    json: {
      "ID_ORCAMENTO": orcamentoId,
      "FECHA": fecha,
      "row_number": item.json["row_number"] || "",
      "NOMBRE CLIENTE": item.json["NOMBRE CLIENTE"] || "",
      "TIPO MUEBLE": item.json["TIPO MUEBLE"] || "",
      "ANCHO": item.json["ANCHO"] || "",
      "PRODUNIDAD": item.json["PRODUNIDAD"] || "",
      "ALTURA": item.json["ALTURA"] || "",
      "MATERIAL": item.json["MATERIAL"] || "",
      "ADICIONALES": item.json["ADICIONALES"] || "",
      "MATERIAL EXTRA": item.json["MATERIAL EXTRA"] || "",
      "PRECIO ADICIONAL": item.json["PRECIO ADICIONAL"] || "",
      "Envio e Instalacion": item.json["Envio e Instalacion"] || "",
      "PRECIO": item.json["PRECIO"] || ""
    }
  });
});

return items;


